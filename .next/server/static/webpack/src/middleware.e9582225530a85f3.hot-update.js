"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/lib/auth.ts":
/*!*************************!*\
  !*** ./src/lib/auth.ts ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   authenticateUser: () => (/* binding */ authenticateUser),\n/* harmony export */   createSession: () => (/* binding */ createSession),\n/* harmony export */   createUser: () => (/* binding */ createUser),\n/* harmony export */   destroyAllUserSessions: () => (/* binding */ destroyAllUserSessions),\n/* harmony export */   destroySession: () => (/* binding */ destroySession),\n/* harmony export */   generateResetToken: () => (/* binding */ generateResetToken),\n/* harmony export */   generateToken: () => (/* binding */ generateToken),\n/* harmony export */   getUserAccounts: () => (/* binding */ getUserAccounts),\n/* harmony export */   hashPassword: () => (/* binding */ hashPassword),\n/* harmony export */   resetPassword: () => (/* binding */ resetPassword),\n/* harmony export */   validateSession: () => (/* binding */ validateSession),\n/* harmony export */   verifyPassword: () => (/* binding */ verifyPassword),\n/* harmony export */   verifyResetToken: () => (/* binding */ verifyResetToken),\n/* harmony export */   verifyToken: () => (/* binding */ verifyToken)\n/* harmony export */ });\n/* harmony import */ var bcryptjs__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! bcryptjs */ \"(middleware)/./node_modules/bcryptjs/index.js\");\n/* harmony import */ var jsonwebtoken__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! jsonwebtoken */ \"(middleware)/./node_modules/jsonwebtoken/index.js\");\n/* harmony import */ var jsonwebtoken__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(jsonwebtoken__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var _db__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./db */ \"(middleware)/./src/lib/db/index.ts\");\n/* harmony import */ var _db_schema__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./db/schema */ \"(middleware)/./src/lib/db/schema.ts\");\n/* harmony import */ var drizzle_orm__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! drizzle-orm */ \"(middleware)/./node_modules/drizzle-orm/sql/expressions/conditions.js\");\n/* harmony import */ var _security__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ./security */ \"(middleware)/./src/lib/security.ts\");\n\n\n\n\n\n\n// JWT_SECRET must be set - no fallback for security\nif (!process.env.JWT_SECRET || process.env.JWT_SECRET === \"your-secret-key\" || process.env.JWT_SECRET.length < 32) {\n    throw new Error(\"JWT_SECRET must be set in environment variables and must be at least 32 characters long. \" + \"Please set a strong random secret in .env.local\");\n}\nconst JWT_SECRET = process.env.JWT_SECRET;\nconst JWT_EXPIRES_IN = \"7d\";\nasync function hashPassword(password) {\n    return bcryptjs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].hash(password, 12);\n}\nasync function verifyPassword(password, hashedPassword) {\n    return bcryptjs__WEBPACK_IMPORTED_MODULE_0__[\"default\"].compare(password, hashedPassword);\n}\nfunction generateToken(user) {\n    return jsonwebtoken__WEBPACK_IMPORTED_MODULE_1___default().sign({\n        id: user.id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        isActive: user.isActive\n    }, JWT_SECRET, {\n        expiresIn: JWT_EXPIRES_IN\n    });\n}\nfunction verifyToken(token) {\n    try {\n        const decoded = jsonwebtoken__WEBPACK_IMPORTED_MODULE_1___default().verify(token, JWT_SECRET);\n        return {\n            id: decoded.id,\n            name: decoded.name,\n            email: decoded.email,\n            role: decoded.role,\n            isActive: decoded.isActive\n        };\n    } catch (error) {\n        return null;\n    }\n}\nasync function createSession(userId, deviceInfo, userData) {\n    // Get user data if not provided\n    let user;\n    if (userData) {\n        user = userData;\n    } else {\n        const userResult = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.id, userId)).limit(1);\n        if (!userResult.length) {\n            throw new Error(\"User not found\");\n        }\n        user = {\n            id: userResult[0].id,\n            name: userResult[0].name,\n            email: userResult[0].email,\n            role: userResult[0].role,\n            isActive: userResult[0].isActive\n        };\n    }\n    const sessionToken = generateToken(user);\n    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.insert(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions).values({\n        userId,\n        sessionToken,\n        deviceInfo: deviceInfo ? JSON.stringify(deviceInfo) : null,\n        expiresAt\n    });\n    return sessionToken;\n}\nasync function validateSession(sessionToken) {\n    const user = verifyToken(sessionToken);\n    if (!user) return null;\n    // Check if session exists in database\n    const session = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.and)((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions.sessionToken, sessionToken), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions.userId, user.id))).limit(1);\n    if (!session.length || session[0].expiresAt < new Date()) {\n        return null;\n    }\n    return user;\n}\nasync function destroySession(sessionToken) {\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.delete(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions.sessionToken, sessionToken));\n}\nasync function destroyAllUserSessions(userId) {\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.delete(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.sessions.userId, userId));\n}\nasync function authenticateUser(email, password, role) {\n    // If role is specified, authenticate that specific role\n    // Otherwise, get the first matching account (for backward compatibility)\n    const whereConditions = role ? (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.and)((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.role, role), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.isActive, true)) : (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.and)((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.isActive, true));\n    const user = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).where(whereConditions).limit(1);\n    if (!user.length) return null;\n    const isValidPassword = await verifyPassword(password, user[0].password);\n    if (!isValidPassword) return null;\n    // Update last login\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.update(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).set({\n        lastLogin: new Date()\n    }).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.id, user[0].id));\n    return {\n        id: user[0].id,\n        name: user[0].name,\n        email: user[0].email,\n        phone: user[0].phone || null,\n        bio: user[0].bio || null,\n        role: user[0].role,\n        isActive: user[0].isActive,\n        faceIdEnrolled: user[0].faceIdEnrolled || false,\n        fingerprintEnrolled: user[0].fingerprintEnrolled || false,\n        twoFactorEnabled: user[0].twoFactorEnabled || false,\n        joinedDate: user[0].joinedDate || null\n    };\n}\n// Get all accounts (roles) for an email\nasync function getUserAccounts(email) {\n    const accounts = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.and)((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.isActive, true)));\n    return accounts.map((user)=>({\n            id: user.id,\n            name: user.name,\n            email: user.email,\n            role: user.role,\n            isActive: user.isActive\n        }));\n}\nasync function createUser(userData) {\n    try {\n        console.log(\"createUser called with:\", {\n            email: userData.email,\n            role: userData.role\n        });\n        // Check if database is initialized\n        if (!_db__WEBPACK_IMPORTED_MODULE_2__.db) {\n            throw new Error(\"Database not initialized. Please check DATABASE_URL in .env.local\");\n        }\n        const hashedPassword = await hashPassword(userData.password);\n        console.log(\"Password hashed successfully\");\n        const newUser = await _db__WEBPACK_IMPORTED_MODULE_2__.db.insert(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).values({\n            name: userData.name,\n            email: userData.email,\n            password: hashedPassword,\n            phone: userData.phone,\n            role: userData.role || \"student\"\n        }).returning();\n        if (!newUser || newUser.length === 0) {\n            throw new Error(\"Failed to create user - no data returned from database\");\n        }\n        console.log(\"User inserted successfully:\", {\n            id: newUser[0].id,\n            email: newUser[0].email\n        });\n        return {\n            id: newUser[0].id,\n            name: newUser[0].name,\n            email: newUser[0].email,\n            role: newUser[0].role,\n            isActive: newUser[0].isActive\n        };\n    } catch (error) {\n        console.error(\"createUser function error:\", error);\n        console.error(\"Error details:\", {\n            message: error?.message,\n            code: error?.code,\n            detail: error?.detail,\n            constraint: error?.constraint\n        });\n        throw error; // Re-throw to let the caller handle it\n    }\n}\nasync function generateResetToken(email) {\n    const user = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email)).limit(1);\n    if (!user.length) return null;\n    // Use cryptographically secure random token\n    const resetToken = (0,_security__WEBPACK_IMPORTED_MODULE_4__.generateSecureToken)(32);\n    const resetTokenExpiry = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.update(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).set({\n        resetToken,\n        resetTokenExpiry\n    }).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.id, user[0].id));\n    return resetToken;\n}\nasync function verifyResetToken(email, token) {\n    const user = await _db__WEBPACK_IMPORTED_MODULE_2__.db.select().from(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.and)((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email), (0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.resetToken, token))).limit(1);\n    if (!user.length || !user[0].resetTokenExpiry) return false;\n    return user[0].resetTokenExpiry > new Date();\n}\nasync function resetPassword(email, token, newPassword) {\n    const isValid = await verifyResetToken(email, token);\n    if (!isValid) return false;\n    const hashedPassword = await hashPassword(newPassword);\n    await _db__WEBPACK_IMPORTED_MODULE_2__.db.update(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users).set({\n        password: hashedPassword,\n        resetToken: null,\n        resetTokenExpiry: null\n    }).where((0,drizzle_orm__WEBPACK_IMPORTED_MODULE_5__.eq)(_db_schema__WEBPACK_IMPORTED_MODULE_3__.users.email, email));\n    return true;\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUNGLDZDQUFLQSxDQUFDc0IsS0FBSyxFQUFFQTtJQUV6QixPQUFPO0FBQ1QiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9fTl9FLy4vc3JjL2xpYi9hdXRoLnRzPzY2OTIiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGJjcnlwdCBmcm9tICdiY3J5cHRqcyc7XHJcbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJztcclxuaW1wb3J0IHsgZGIgfSBmcm9tICcuL2RiJztcclxuaW1wb3J0IHsgdXNlcnMsIHNlc3Npb25zIH0gZnJvbSAnLi9kYi9zY2hlbWEnO1xyXG5pbXBvcnQgeyBlcSwgYW5kIH0gZnJvbSAnZHJpenpsZS1vcm0nO1xyXG5pbXBvcnQgeyBnZW5lcmF0ZVNlY3VyZVRva2VuIH0gZnJvbSAnLi9zZWN1cml0eSc7XHJcblxyXG4vLyBKV1RfU0VDUkVUIG11c3QgYmUgc2V0IC0gbm8gZmFsbGJhY2sgZm9yIHNlY3VyaXR5XHJcbmlmICghcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCB8fCBwcm9jZXNzLmVudi5KV1RfU0VDUkVUID09PSAneW91ci1zZWNyZXQta2V5JyB8fCBwcm9jZXNzLmVudi5KV1RfU0VDUkVULmxlbmd0aCA8IDMyKSB7XHJcbiAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgJ0pXVF9TRUNSRVQgbXVzdCBiZSBzZXQgaW4gZW52aXJvbm1lbnQgdmFyaWFibGVzIGFuZCBtdXN0IGJlIGF0IGxlYXN0IDMyIGNoYXJhY3RlcnMgbG9uZy4gJyArXHJcbiAgICAnUGxlYXNlIHNldCBhIHN0cm9uZyByYW5kb20gc2VjcmV0IGluIC5lbnYubG9jYWwnXHJcbiAgKTtcclxufVxyXG5cclxuY29uc3QgSldUX1NFQ1JFVCA9IHByb2Nlc3MuZW52LkpXVF9TRUNSRVQ7XHJcbmNvbnN0IEpXVF9FWFBJUkVTX0lOID0gJzdkJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFVzZXIge1xyXG4gIGlkOiBudW1iZXI7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIGVtYWlsOiBzdHJpbmc7XHJcbiAgcGhvbmU6IHN0cmluZyB8IG51bGw7XHJcbiAgYmlvOiBzdHJpbmcgfCBudWxsO1xyXG4gIHJvbGU6IHN0cmluZztcclxuICBpc0FjdGl2ZTogYm9vbGVhbjtcclxuICBmYWNlSWRFbnJvbGxlZDogYm9vbGVhbjtcclxuICBmaW5nZXJwcmludEVucm9sbGVkOiBib29sZWFuO1xyXG4gIHR3b0ZhY3RvckVuYWJsZWQ6IGJvb2xlYW47XHJcbiAgam9pbmVkRGF0ZTogRGF0ZSB8IG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYXNoUGFzc3dvcmQocGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIGJjcnlwdC5oYXNoKHBhc3N3b3JkLCAxMik7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlQYXNzd29yZChwYXNzd29yZDogc3RyaW5nLCBoYXNoZWRQYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgcmV0dXJuIGJjcnlwdC5jb21wYXJlKHBhc3N3b3JkLCBoYXNoZWRQYXNzd29yZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVRva2VuKHVzZXI6IEF1dGhVc2VyKTogc3RyaW5nIHtcclxuICByZXR1cm4gand0LnNpZ24oXHJcbiAgICB7XHJcbiAgICAgIGlkOiB1c2VyLmlkLFxyXG4gICAgICBuYW1lOiB1c2VyLm5hbWUsXHJcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxyXG4gICAgICByb2xlOiB1c2VyLnJvbGUsXHJcbiAgICAgIGlzQWN0aXZlOiB1c2VyLmlzQWN0aXZlLFxyXG4gICAgfSxcclxuICAgIEpXVF9TRUNSRVQsXHJcbiAgICB7IGV4cGlyZXNJbjogSldUX0VYUElSRVNfSU4gfVxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB2ZXJpZnlUb2tlbih0b2tlbjogc3RyaW5nKTogQXV0aFVzZXIgfCBudWxsIHtcclxuICB0cnkge1xyXG4gICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIEpXVF9TRUNSRVQpIGFzIGFueTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGlkOiBkZWNvZGVkLmlkLFxyXG4gICAgICBuYW1lOiBkZWNvZGVkLm5hbWUsXHJcbiAgICAgIGVtYWlsOiBkZWNvZGVkLmVtYWlsLFxyXG4gICAgICByb2xlOiBkZWNvZGVkLnJvbGUsXHJcbiAgICAgIGlzQWN0aXZlOiBkZWNvZGVkLmlzQWN0aXZlLFxyXG4gICAgfTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlU2Vzc2lvbih1c2VySWQ6IG51bWJlciwgZGV2aWNlSW5mbz86IGFueSwgdXNlckRhdGE/OiBBdXRoVXNlcik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgLy8gR2V0IHVzZXIgZGF0YSBpZiBub3QgcHJvdmlkZWRcclxuICBsZXQgdXNlcjogQXV0aFVzZXI7XHJcbiAgaWYgKHVzZXJEYXRhKSB7XHJcbiAgICB1c2VyID0gdXNlckRhdGE7XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnN0IHVzZXJSZXN1bHQgPSBhd2FpdCBkYlxyXG4gICAgICAuc2VsZWN0KClcclxuICAgICAgLmZyb20odXNlcnMpXHJcbiAgICAgIC53aGVyZShlcSh1c2Vycy5pZCwgdXNlcklkKSlcclxuICAgICAgLmxpbWl0KDEpO1xyXG4gICAgXHJcbiAgICBpZiAoIXVzZXJSZXN1bHQubGVuZ3RoKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVXNlciBub3QgZm91bmQnKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgdXNlciA9IHtcclxuICAgICAgaWQ6IHVzZXJSZXN1bHRbMF0uaWQsXHJcbiAgICAgIG5hbWU6IHVzZXJSZXN1bHRbMF0ubmFtZSxcclxuICAgICAgZW1haWw6IHVzZXJSZXN1bHRbMF0uZW1haWwsXHJcbiAgICAgIHJvbGU6IHVzZXJSZXN1bHRbMF0ucm9sZSxcclxuICAgICAgaXNBY3RpdmU6IHVzZXJSZXN1bHRbMF0uaXNBY3RpdmUsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgY29uc3Qgc2Vzc2lvblRva2VuID0gZ2VuZXJhdGVUb2tlbih1c2VyKTtcclxuICBjb25zdCBleHBpcmVzQXQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyA3IGRheXNcclxuXHJcbiAgYXdhaXQgZGIuaW5zZXJ0KHNlc3Npb25zKS52YWx1ZXMoe1xyXG4gICAgdXNlcklkLFxyXG4gICAgc2Vzc2lvblRva2VuLFxyXG4gICAgZGV2aWNlSW5mbzogZGV2aWNlSW5mbyA/IEpTT04uc3RyaW5naWZ5KGRldmljZUluZm8pIDogbnVsbCxcclxuICAgIGV4cGlyZXNBdCxcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHNlc3Npb25Ub2tlbjtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlU2Vzc2lvbihzZXNzaW9uVG9rZW46IHN0cmluZyk6IFByb21pc2U8QXV0aFVzZXIgfCBudWxsPiB7XHJcbiAgY29uc3QgdXNlciA9IHZlcmlmeVRva2VuKHNlc3Npb25Ub2tlbik7XHJcbiAgaWYgKCF1c2VyKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgLy8gQ2hlY2sgaWYgc2Vzc2lvbiBleGlzdHMgaW4gZGF0YWJhc2VcclxuICBjb25zdCBzZXNzaW9uID0gYXdhaXQgZGJcclxuICAgIC5zZWxlY3QoKVxyXG4gICAgLmZyb20oc2Vzc2lvbnMpXHJcbiAgICAud2hlcmUoXHJcbiAgICAgIGFuZChcclxuICAgICAgICBlcShzZXNzaW9ucy5zZXNzaW9uVG9rZW4sIHNlc3Npb25Ub2tlbiksXHJcbiAgICAgICAgZXEoc2Vzc2lvbnMudXNlcklkLCB1c2VyLmlkKVxyXG4gICAgICApXHJcbiAgICApXHJcbiAgICAubGltaXQoMSk7XHJcblxyXG4gIGlmICghc2Vzc2lvbi5sZW5ndGggfHwgc2Vzc2lvblswXS5leHBpcmVzQXQgPCBuZXcgRGF0ZSgpKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIHJldHVybiB1c2VyO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVzdHJveVNlc3Npb24oc2Vzc2lvblRva2VuOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICBhd2FpdCBkYi5kZWxldGUoc2Vzc2lvbnMpLndoZXJlKGVxKHNlc3Npb25zLnNlc3Npb25Ub2tlbiwgc2Vzc2lvblRva2VuKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZXN0cm95QWxsVXNlclNlc3Npb25zKHVzZXJJZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgYXdhaXQgZGIuZGVsZXRlKHNlc3Npb25zKS53aGVyZShlcShzZXNzaW9ucy51c2VySWQsIHVzZXJJZCkpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXV0aGVudGljYXRlVXNlcihlbWFpbDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCByb2xlPzogc3RyaW5nKTogUHJvbWlzZTxBdXRoVXNlciB8IG51bGw+IHtcclxuICAvLyBJZiByb2xlIGlzIHNwZWNpZmllZCwgYXV0aGVudGljYXRlIHRoYXQgc3BlY2lmaWMgcm9sZVxyXG4gIC8vIE90aGVyd2lzZSwgZ2V0IHRoZSBmaXJzdCBtYXRjaGluZyBhY2NvdW50IChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSlcclxuICBjb25zdCB3aGVyZUNvbmRpdGlvbnMgPSByb2xlIFxyXG4gICAgPyBhbmQoZXEodXNlcnMuZW1haWwsIGVtYWlsKSwgZXEodXNlcnMucm9sZSwgcm9sZSksIGVxKHVzZXJzLmlzQWN0aXZlLCB0cnVlKSlcclxuICAgIDogYW5kKGVxKHVzZXJzLmVtYWlsLCBlbWFpbCksIGVxKHVzZXJzLmlzQWN0aXZlLCB0cnVlKSk7XHJcbiAgXHJcbiAgY29uc3QgdXNlciA9IGF3YWl0IGRiXHJcbiAgICAuc2VsZWN0KClcclxuICAgIC5mcm9tKHVzZXJzKVxyXG4gICAgLndoZXJlKHdoZXJlQ29uZGl0aW9ucylcclxuICAgIC5saW1pdCgxKTtcclxuXHJcbiAgaWYgKCF1c2VyLmxlbmd0aCkgcmV0dXJuIG51bGw7XHJcblxyXG4gIGNvbnN0IGlzVmFsaWRQYXNzd29yZCA9IGF3YWl0IHZlcmlmeVBhc3N3b3JkKHBhc3N3b3JkLCB1c2VyWzBdLnBhc3N3b3JkKTtcclxuICBpZiAoIWlzVmFsaWRQYXNzd29yZCkgcmV0dXJuIG51bGw7XHJcblxyXG4gIC8vIFVwZGF0ZSBsYXN0IGxvZ2luXHJcbiAgYXdhaXQgZGJcclxuICAgIC51cGRhdGUodXNlcnMpXHJcbiAgICAuc2V0KHsgbGFzdExvZ2luOiBuZXcgRGF0ZSgpIH0pXHJcbiAgICAud2hlcmUoZXEodXNlcnMuaWQsIHVzZXJbMF0uaWQpKTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGlkOiB1c2VyWzBdLmlkLFxyXG4gICAgbmFtZTogdXNlclswXS5uYW1lLFxyXG4gICAgZW1haWw6IHVzZXJbMF0uZW1haWwsXHJcbiAgICBwaG9uZTogdXNlclswXS5waG9uZSB8fCBudWxsLFxyXG4gICAgYmlvOiB1c2VyWzBdLmJpbyB8fCBudWxsLFxyXG4gICAgcm9sZTogdXNlclswXS5yb2xlLFxyXG4gICAgaXNBY3RpdmU6IHVzZXJbMF0uaXNBY3RpdmUsXHJcbiAgICBmYWNlSWRFbnJvbGxlZDogdXNlclswXS5mYWNlSWRFbnJvbGxlZCB8fCBmYWxzZSxcclxuICAgIGZpbmdlcnByaW50RW5yb2xsZWQ6IHVzZXJbMF0uZmluZ2VycHJpbnRFbnJvbGxlZCB8fCBmYWxzZSxcclxuICAgIHR3b0ZhY3RvckVuYWJsZWQ6IHVzZXJbMF0udHdvRmFjdG9yRW5hYmxlZCB8fCBmYWxzZSxcclxuICAgIGpvaW5lZERhdGU6IHVzZXJbMF0uam9pbmVkRGF0ZSB8fCBudWxsLFxyXG4gIH07XHJcbn1cclxuXHJcbi8vIEdldCBhbGwgYWNjb3VudHMgKHJvbGVzKSBmb3IgYW4gZW1haWxcclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFVzZXJBY2NvdW50cyhlbWFpbDogc3RyaW5nKTogUHJvbWlzZTxBdXRoVXNlcltdPiB7XHJcbiAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCBkYlxyXG4gICAgLnNlbGVjdCgpXHJcbiAgICAuZnJvbSh1c2VycylcclxuICAgIC53aGVyZShhbmQoZXEodXNlcnMuZW1haWwsIGVtYWlsKSwgZXEodXNlcnMuaXNBY3RpdmUsIHRydWUpKSk7XHJcblxyXG4gIHJldHVybiBhY2NvdW50cy5tYXAodXNlciA9PiAoe1xyXG4gICAgaWQ6IHVzZXIuaWQsXHJcbiAgICBuYW1lOiB1c2VyLm5hbWUsXHJcbiAgICBlbWFpbDogdXNlci5lbWFpbCxcclxuICAgIHJvbGU6IHVzZXIucm9sZSxcclxuICAgIGlzQWN0aXZlOiB1c2VyLmlzQWN0aXZlLFxyXG4gIH0pKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVVzZXIodXNlckRhdGE6IHtcclxuICBuYW1lOiBzdHJpbmc7XHJcbiAgZW1haWw6IHN0cmluZztcclxuICBwYXNzd29yZDogc3RyaW5nO1xyXG4gIHBob25lPzogc3RyaW5nO1xyXG4gIHJvbGU/OiBzdHJpbmc7XHJcbn0pOiBQcm9taXNlPEF1dGhVc2VyPiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnNvbGUubG9nKCdjcmVhdGVVc2VyIGNhbGxlZCB3aXRoOicsIHsgZW1haWw6IHVzZXJEYXRhLmVtYWlsLCByb2xlOiB1c2VyRGF0YS5yb2xlIH0pO1xyXG4gICAgXHJcbiAgICAvLyBDaGVjayBpZiBkYXRhYmFzZSBpcyBpbml0aWFsaXplZFxyXG4gICAgaWYgKCFkYikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlIG5vdCBpbml0aWFsaXplZC4gUGxlYXNlIGNoZWNrIERBVEFCQVNFX1VSTCBpbiAuZW52LmxvY2FsJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBoYXNoUGFzc3dvcmQodXNlckRhdGEucGFzc3dvcmQpO1xyXG4gICAgY29uc29sZS5sb2coJ1Bhc3N3b3JkIGhhc2hlZCBzdWNjZXNzZnVsbHknKTtcclxuXHJcbiAgICBjb25zdCBuZXdVc2VyID0gYXdhaXQgZGJcclxuICAgICAgLmluc2VydCh1c2VycylcclxuICAgICAgLnZhbHVlcyh7XHJcbiAgICAgICAgbmFtZTogdXNlckRhdGEubmFtZSxcclxuICAgICAgICBlbWFpbDogdXNlckRhdGEuZW1haWwsXHJcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxyXG4gICAgICAgIHBob25lOiB1c2VyRGF0YS5waG9uZSxcclxuICAgICAgICByb2xlOiB1c2VyRGF0YS5yb2xlIHx8ICdzdHVkZW50JyxcclxuICAgICAgfSlcclxuICAgICAgLnJldHVybmluZygpO1xyXG5cclxuICAgIGlmICghbmV3VXNlciB8fCBuZXdVc2VyLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgdXNlciAtIG5vIGRhdGEgcmV0dXJuZWQgZnJvbSBkYXRhYmFzZScpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnNvbGUubG9nKCdVc2VyIGluc2VydGVkIHN1Y2Nlc3NmdWxseTonLCB7IGlkOiBuZXdVc2VyWzBdLmlkLCBlbWFpbDogbmV3VXNlclswXS5lbWFpbCB9KTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBpZDogbmV3VXNlclswXS5pZCxcclxuICAgICAgbmFtZTogbmV3VXNlclswXS5uYW1lLFxyXG4gICAgICBlbWFpbDogbmV3VXNlclswXS5lbWFpbCxcclxuICAgICAgcm9sZTogbmV3VXNlclswXS5yb2xlLFxyXG4gICAgICBpc0FjdGl2ZTogbmV3VXNlclswXS5pc0FjdGl2ZSxcclxuICAgIH07XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5lcnJvcignY3JlYXRlVXNlciBmdW5jdGlvbiBlcnJvcjonLCBlcnJvcik7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkZXRhaWxzOicsIHtcclxuICAgICAgbWVzc2FnZTogZXJyb3I/Lm1lc3NhZ2UsXHJcbiAgICAgIGNvZGU6IGVycm9yPy5jb2RlLFxyXG4gICAgICBkZXRhaWw6IGVycm9yPy5kZXRhaWwsXHJcbiAgICAgIGNvbnN0cmFpbnQ6IGVycm9yPy5jb25zdHJhaW50LFxyXG4gICAgfSk7XHJcbiAgICB0aHJvdyBlcnJvcjsgLy8gUmUtdGhyb3cgdG8gbGV0IHRoZSBjYWxsZXIgaGFuZGxlIGl0XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVSZXNldFRva2VuKGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcclxuICBjb25zdCB1c2VyID0gYXdhaXQgZGJcclxuICAgIC5zZWxlY3QoKVxyXG4gICAgLmZyb20odXNlcnMpXHJcbiAgICAud2hlcmUoZXEodXNlcnMuZW1haWwsIGVtYWlsKSlcclxuICAgIC5saW1pdCgxKTtcclxuXHJcbiAgaWYgKCF1c2VyLmxlbmd0aCkgcmV0dXJuIG51bGw7XHJcblxyXG4gIC8vIFVzZSBjcnlwdG9ncmFwaGljYWxseSBzZWN1cmUgcmFuZG9tIHRva2VuXHJcbiAgY29uc3QgcmVzZXRUb2tlbiA9IGdlbmVyYXRlU2VjdXJlVG9rZW4oMzIpO1xyXG4gIGNvbnN0IHJlc2V0VG9rZW5FeHBpcnkgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgNjAgKiA2MCAqIDEwMDApOyAvLyAxIGhvdXJcclxuXHJcbiAgYXdhaXQgZGJcclxuICAgIC51cGRhdGUodXNlcnMpXHJcbiAgICAuc2V0KHtcclxuICAgICAgcmVzZXRUb2tlbixcclxuICAgICAgcmVzZXRUb2tlbkV4cGlyeSxcclxuICAgIH0pXHJcbiAgICAud2hlcmUoZXEodXNlcnMuaWQsIHVzZXJbMF0uaWQpKTtcclxuXHJcbiAgcmV0dXJuIHJlc2V0VG9rZW47XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlSZXNldFRva2VuKGVtYWlsOiBzdHJpbmcsIHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICBjb25zdCB1c2VyID0gYXdhaXQgZGJcclxuICAgIC5zZWxlY3QoKVxyXG4gICAgLmZyb20odXNlcnMpXHJcbiAgICAud2hlcmUoYW5kKFxyXG4gICAgICBlcSh1c2Vycy5lbWFpbCwgZW1haWwpLFxyXG4gICAgICBlcSh1c2Vycy5yZXNldFRva2VuLCB0b2tlbilcclxuICAgICkpXHJcbiAgICAubGltaXQoMSk7XHJcblxyXG4gIGlmICghdXNlci5sZW5ndGggfHwgIXVzZXJbMF0ucmVzZXRUb2tlbkV4cGlyeSkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICByZXR1cm4gdXNlclswXS5yZXNldFRva2VuRXhwaXJ5ID4gbmV3IERhdGUoKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlc2V0UGFzc3dvcmQoZW1haWw6IHN0cmluZywgdG9rZW46IHN0cmluZywgbmV3UGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCB2ZXJpZnlSZXNldFRva2VuKGVtYWlsLCB0b2tlbik7XHJcbiAgaWYgKCFpc1ZhbGlkKSByZXR1cm4gZmFsc2U7XHJcblxyXG4gIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgaGFzaFBhc3N3b3JkKG5ld1Bhc3N3b3JkKTtcclxuXHJcbiAgYXdhaXQgZGJcclxuICAgIC51cGRhdGUodXNlcnMpXHJcbiAgICAuc2V0KHtcclxuICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxyXG4gICAgICByZXNldFRva2VuOiBudWxsLFxyXG4gICAgICByZXNldFRva2VuRXhwaXJ5OiBudWxsLFxyXG4gICAgfSlcclxuICAgIC53aGVyZShlcSh1c2Vycy5lbWFpbCwgZW1haWwpKTtcclxuXHJcbiAgcmV0dXJuIHRydWU7XHJcbn1cclxuIl0sIm5hbWVzIjpbImJjcnlwdCIsImp3dCIsImRiIiwidXNlcnMiLCJzZXNzaW9ucyIsImVxIiwiYW5kIiwiZ2VuZXJhdGVTZWN1cmVUb2tlbiIsInByb2Nlc3MiLCJlbnYiLCJKV1RfU0VDUkVUIiwibGVuZ3RoIiwiRXJyb3IiLCJKV1RfRVhQSVJFU19JTiIsImhhc2hQYXNzd29yZCIsInBhc3N3b3JkIiwiaGFzaCIsInZlcmlmeVBhc3N3b3JkIiwiaGFzaGVkUGFzc3dvcmQiLCJjb21wYXJlIiwiZ2VuZXJhdGVUb2tlbiIsInVzZXIiLCJzaWduIiwiaWQiLCJuYW1lIiwiZW1haWwiLCJyb2xlIiwiaXNBY3RpdmUiLCJleHBpcmVzSW4iLCJ2ZXJpZnlUb2tlbiIsInRva2VuIiwiZGVjb2RlZCIsInZlcmlmeSIsImVycm9yIiwiY3JlYXRlU2Vzc2lvbiIsInVzZXJJZCIsImRldmljZUluZm8iLCJ1c2VyRGF0YSIsInVzZXJSZXN1bHQiLCJzZWxlY3QiLCJmcm9tIiwid2hlcmUiLCJsaW1pdCIsInNlc3Npb25Ub2tlbiIsImV4cGlyZXNBdCIsIkRhdGUiLCJub3ciLCJpbnNlcnQiLCJ2YWx1ZXMiLCJKU09OIiwic3RyaW5naWZ5IiwidmFsaWRhdGVTZXNzaW9uIiwic2Vzc2lvbiIsImRlc3Ryb3lTZXNzaW9uIiwiZGVsZXRlIiwiZGVzdHJveUFsbFVzZXJTZXNzaW9ucyIsImF1dGhlbnRpY2F0ZVVzZXIiLCJ3aGVyZUNvbmRpdGlvbnMiLCJpc1ZhbGlkUGFzc3dvcmQiLCJ1cGRhdGUiLCJzZXQiLCJsYXN0TG9naW4iLCJwaG9uZSIsImJpbyIsImZhY2VJZEVucm9sbGVkIiwiZmluZ2VycHJpbnRFbnJvbGxlZCIsInR3b0ZhY3RvckVuYWJsZWQiLCJqb2luZWREYXRlIiwiZ2V0VXNlckFjY291bnRzIiwiYWNjb3VudHMiLCJtYXAiLCJjcmVhdGVVc2VyIiwiY29uc29sZSIsImxvZyIsIm5ld1VzZXIiLCJyZXR1cm5pbmciLCJtZXNzYWdlIiwiY29kZSIsImRldGFpbCIsImNvbnN0cmFpbnQiLCJnZW5lcmF0ZVJlc2V0VG9rZW4iLCJyZXNldFRva2VuIiwicmVzZXRUb2tlbkV4cGlyeSIsInZlcmlmeVJlc2V0VG9rZW4iLCJyZXNldFBhc3N3b3JkIiwibmV3UGFzc3dvcmQiLCJpc1ZhbGlkIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(middleware)/./src/lib/auth.ts\n");

/***/ })

});